{{- define "virtual" }}
{{-  range $i, $v :=  index .F5config.LtmVirtual -}}
{{-    template "frontend" (dict "frontend" $v "root" $ ) -}}
{{   end -}}
{{ end -}}

{{- define "fe-profiles" }}
{{-   $profiles := index . "profiles" }}
{{-   $root := index . "root" }}
{{-   range $pi, $profile := index $profiles }}
{{-       if hasTemplate $profile.Name }}
{{-         templateIndent 4 $profile.Name . -}}
{{-       else }}
    ### No definition found for profile {{ $profile.Name }}
{{-       end }}
{{-    end }}
{{- end -}}

{{- define "fe-rules" }}
{{-   $rules := index . "rules" }}
{{-   $root := index . "root" }}
{{-   range $ri, $rulename := index $rules }}
{{-     with index $root.F5config.LtmRule $rulename }}
{{-       if hasTemplate $rulename }}
{{-         templateIndent 4 $rulename . -}}
{{-       else }}
{{-         templateIndent 4 "block_original" ( dict "block" . "type" "rule" ) }}
{{-       end }}
{{-     end }}
{{-   end}}
{{ end }}

{{- define "fe-persistences" }}
{{-   $persistences := index . "persistences" }}
{{-   $root := index . "root" }}
{{-   range $ri, $persistence := index $persistences }}
{{-     with index $root.F5config.LtmPersistence $persistence.Name }}
{{-       if hasTemplate $persistence.Name }}
{{-         templateIndent 4 $persistence.Name . -}}
{{-       else }}
{{-         templateIndent 4 "block_original" ( dict "block" . "type" "persistence" ) }}
{{-       end }}
{{-     end }}
{{-   end}}
{{ end }}



{{ define "frontend" }}
{{-   $fe := index . "frontend" }}
{{-   $root := index . "root" }}
{{-   template "block_original" ( dict "block" $fe "type" "virtual" "root" $root ) }}
frontend {{ $fe.Name }}
    bind {{ ipport $fe.Destination }}
{{    template "fe-persistences" ( dict "persistences" $fe.Persist "root" $root ) }}
{{    template "fe-profiles" ( dict "profiles" $fe.Profiles "root" $root ) }}
{{    template "fe-rules" ( dict "rules" $fe.Rules "root" $root ) }}
{{ end }}
