{{- define "virtual" }}
{{-  range $i, $v :=  index .F5config.LtmVirtual -}}
{{-    template "frontend" (dict "frontend" $v "root" $ ) -}}
{{   end -}}
{{ end -}}

{{- define "fe-profiles" }}
{{-   range $pi, $profile := index . }}
{{-       if hasTemplate $profile.Name }}
{{-         templateIfExists $profile.Name . -}}
{{-       else }}
    ### No definition found for profile {{ $profile.Name }}
{{-       end }}
{{-    end }}
{{- end -}}

{{- define "fe-rules" }}
{{-   $rules := index . "rules" }}
{{-   $root := index . "root" }}
{{-   range $ri, $rulename := index $rules }}
{{-     with index $root.F5config.LtmRule $rulename }}
{{-       if hasTemplate $rulename }}
{{-         templateIfExists $rulename . -}}
{{-       else }}
{{-         templateIndent 4 "block_original" ( dict "block" . "type" "rule" ) }}
{{-       end }}
{{-     end }}
{{    end}}{{/* end of range */}}
{{ end }}



{{ define "frontend" }}
{{-   $fe := index . "frontend" }}
{{-   $root := index . "root" }}
{{-   template "block_original" ( dict "block" $fe "type" "virtual" "root" $root ) }}
frontend {{ $fe.Name }}
    bind {{ ipport $fe.Destination }}
{{    template "fe-profiles" $fe.Profiles }}
{{    template "fe-rules" ( dict "rules" $fe.Rules "root" $root ) }}
{{ end }}
