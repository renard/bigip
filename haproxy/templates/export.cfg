{{ define "delimiter" }}
# ---8<---8<---8<---8<---8<---{{ end }}

{{/*
# block_header writes a block (rule, profile, etc) header which
# contains the type, the name and the source of original block
# definition.
#
# Context should be a map with:
#
# Context should be a map like block_original.
*/}}
{{- define "block_header" }}
{{-   $block := index . "block" }}
{{-   $type := index . "type" }}
### {{ $type }}: {{ $block.Name }}
## file: {{ $block.OriginalConfig.File }}, lines: {{ index $block.OriginalConfig.Lines 0 }}-{{ index $block.OriginalConfig.Lines 1 }}
#
{{-   template "delimiter" }}
{{- end }}


{{/*
# block_footer writes a block (rule, profile, etc) footer which
# contains the type, the name of the block.
#
# Context should be a map like block_original.
*/}}
{{- define "block_footer" }}
{{-   $block := index . "block" }}
{{-   $type := index . "type" }}
{{-   template "delimiter" }}
#
{{-   with index . "translated" }}{{ . }}{{ end }}
### /{{ $type }}: {{ $block.Name }}
{{- end }}


{{/*
# block_original writes a block (rule, profile, etc) footer, original
# definition in comments and footer.
#
# * block: the block definition
# * type: a string defining the block type (rule, profile, etc...)
*/}}
{{- define "block_original" }}
{{-   template "block_header" . }}
{{      scomment ( index . "block" ).Original 4 0 }}
{{-   template "block_footer" . }}
{{- end }}

{{/*
# block writes a block (rule, profile, etc) template for later use
#
# * blocks: a list of all block definitions
# * type: a string defining the block type (rule, profile, etc...)
#
# If a block is already defined, its definition will be used instead
# of the parsed value. This allows to iterate over block definitions.
*/}}
{{- define "block" }}
{{-   $existing := 0 }}
{{-   $type := index . "type" }}
{{-   $blocks := index . "blocks" }}
{{ "{{- /*" }}
###
### {{ $type }} definitions
###
{{ "*/ -}}" }}
{{    range $idx, $block := index $blocks }}
{{ "{{" }} define "{{ $block.Name }}" {{ "}}" }}
{{-      if hasTemplate $block.Name }}
{{-      template "block_original" ( dict "block" $block "type" $type "translated" (templateIfExists $block.Name $block) ) }}
{{- /*          templateIfExists $block.Name $block */}}
{{-          $existing = add $existing 1 }}
{{-      else }}
{{-      template "block_original" ( dict "block" $block "type" $type ) }}
{{       end }}
{{- "{{ end }}" }}

{{    end }}
{{ "{{- /*" }}
###
### {{ len $blocks }} {{ $type }} definitons ({{ $existing }} existing)
###
{{ "*/ -}}" }}
{{ end }}


{{ define "export" }}
{{-   with .F5config.LtmRule }}
{{-    template "block" ( dict "blocks" . "type" "rule" "root" $ ) }}
{{-   end }}
{{-   with .F5config.LtmProfile }}
{{-     template "block" ( dict "blocks" . "type" "profile" "root" $ ) }}
{{-   end }}
{{-   with .F5config.LtmNode }}
{{-     template "block" ( dict "blocks" . "type" "node" "root" $ ) }}
{{-   end }}
{{- end }}
