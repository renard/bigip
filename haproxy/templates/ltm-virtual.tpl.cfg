{{/*
# block_virtual converts a F5Pool into HAProxy backend.
#
*/}}
{{ define "block_virtual" }}
{{-   $block := index . "block" }}
frontend {{ normalize $block.Name  }}
    bind {{ ipport $block.Destination }}{{ if eq $block.Source "0.0.0.0/0" }} transparent{{ end }}
{{-   with $block.VsIndex }}
    id {{ $block.VsIndex }}
{{-   end }}
    mode {{ with $block.IpProtocol }}{{ if eq "tcp" . }}tcp{{ else }}http{{ end }}{{ else }}http{{ end }}
{{-   with $block.Persist }}
    # persistences
{{-     range $i, $persistence := . }}
{{        printf "{{   templateIndent 4 \"persistence:%s\" \"\" }}" $persistence.Name  }}
{{-     end }}
{{-   end }}
{{-   with $block.Profiles }}
    # profiles
{{-     range $i, $profile := . }}
{{        printf "{{   templateIndent 4 \"profile:%s\" \"\" }}" $profile.Name  }}
{{-     end }}
{{-   end }}
{{-   with $block.Rules }}
    # rules
{{-     range $i, $rule := . }}
{{        printf "{{   templateIndent 4 \"rule:%s\" \"\" }}" $rule  }}
{{-     end }}
{{-   end }}
{{-   with $block.Policies }}
    # policies
{{-     range $i, $policy := . }}
{{        printf "{{   templateIndent 4 \"policy:%s\" \"\" }}" $policy.Name  }}
{{-     end }}
{{-   end }}
{{-   with $block.Pool }}
    default_backend {{ . }}
{{-   end }}
{{- end }}
